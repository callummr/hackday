"use strict";angular.module("ngSwApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","toastr","ne.swapi","colorpicker.module"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",controllerAs:"main"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl",controllerAs:"about"}).when("/faceSettings/:uid?",{templateUrl:"views/facesettings.html",controller:"FacesettingsCtrl",controllerAs:"faceSettings"}).when("/swapitest",{templateUrl:"views/swapitest.html",controller:"SwapitestCtrl",controllerAs:"swapitest"}).when("/processing",{templateUrl:"views/processing.html",controller:"ProcessingCtrl",controllerAs:"processing"}).otherwise({redirectTo:"/"})}]),angular.module("ngSwApp").controller("MainCtrl",[function(){}]),angular.module("ngSwApp").controller("AboutCtrl",[function(){this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),function(){navigator.getMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,window.hasUserMedia=function(){return navigator.getMedia?!0:!1}}(),angular.module("ngSwApp").directive("webcam",["toastr","betaface","$routeParams","$location",function(a,b,c,d){return{template:'<div class="webcam-container"><div class="row"><div class="col-lg-6 col-sm-12 text-center"><button class="btn btn-lg btn-default" ng-click="savePhoto()" ng-disabled="!photoReady">Take Photo</button></div><div class="col-lg-6 col-sm-12 text-center"><button class="btn btn-lg btn-default" ng-click="uploadPhoto()" ng-disabled="!uploadReady">Upload Photo</button></div></div><!-- webcam itself is inserted below --><div class="row"><div class="webcam-video col-lg-6 col-sm-12 text-center"></div><div class="webcam-photo col-lg-6 col-sm-12 text-center"></div></div></div>',restrict:"E",replace:!0,transclude:!0,scope:{onError:"&",onStream:"&",onStreaming:"&",placeholder:"=",config:"=channel"},link:function(c,e){var f=null,g=null,h=null;c.config=c.config||{},c.photoReady=!1,c.uploadReady=!1;var i=function(a){a&&angular.element(a).remove()},j=function(){g&&"function"==typeof g.stop&&g.stop(),f&&delete f.src},k=function(b){if(a.success("Photon receptor detected"),g=b,navigator.mozGetUserMedia)f.mozSrcObject=b;else{var d=window.URL||window.webkitURL;f.src=d.createObjectURL(b)}f.play(),c.config.video=f,c.onStream&&c.onStream({stream:b}),c.photoReady=!0},l=function(b){a.warning("Falling back to manual entry","Photon receptor failure"),i(h),console&&console.log&&console.log("Webcam initialization failed: ",b),c.onError&&c.onError({err:b}),d.path("/faceSettings")},m=(c.savePhoto=function(){if(!c.config.canvas){var a=document.createElement("canvas");a.setAttribute("width",f.videoWidth),a.setAttribute("height",f.videoHeight),e.find(".webcam-photo").append(a),c.config.canvas=a}var b=c.config.canvas,d=b.getContext("2d");d.drawImage(f,0,0,f.width,f.height),c.imgData=b.toDataURL("image/png"),c.uploadReady=!0},c.uploadPhoto=function(){var e=c.imgData,f=b.upload(e);f.$promise.then(function(a){d.path("/faceSettings/"+a.img_uid)},function(b){a.warning("Manual processing fallback engaged","Photon pattern recognition failed"),d.path("/faceSettings")})},function(){f=document.createElement("video"),f.setAttribute("class","webcam-live"),f.setAttribute("autoplay",""),e.find(".webcam-video").append(f),c.placeholder&&(h=document.createElement("img"),h.setAttribute("class","webcam-loader"),h.src=c.placeholder,e.find(".webcam-video").append(h));var a=!1,b=e.width=c.config.videoWidth||320,d=e.height=0;if(!window.hasUserMedia())return void l({code:-1,msg:"Browser does not support getUserMedia."});var g={video:!0,audio:!1};navigator.getMedia(g,k,l),f.addEventListener("canplay",function(){if(!a){var e=b/f.videoWidth;d=f.videoHeight*e||c.config.videoHeight,f.setAttribute("width",b),f.setAttribute("height",d),a=!0,c.config.video=f,i(h),c.onStreaming&&c.onStreaming()}},!1)}),n=function(){j(),f.remove()};c.$on("$destroy",j),c.$on("START_WEBCAM",m),c.$on("STOP_WEBCAM",n),m()}}}]),angular.module("ngSwApp").service("betaface",["$resource","guid",function(a,b){function c(a){console.log(a)}var d="d45fd466-51e2-4701-8da8-04351c872236",e="171e8465-f548-401d-b63b-caf0dc28df5f",f="http://www.betafaceapi.com/service_json.svc/",g={uploadImage:{method:"POST",params:{},url:f+"UploadImage"},getInfo:{method:"POST",params:{},url:f+"GetImageInfo"}},h=a(f,{},g);this.upload=function(a){return a=a.split(",")[1],h.uploadImage({},{api_key:d,api_secret:e,original_filename:""+b.generate()+".jpg",detection_flags:"extended,classifiers",image_base64:a},c,c)},this.getInfo=function(a){return h.getInfo({},{api_key:"d45fd466-51e2-4701-8da8-04351c872236",api_secret:"171e8465-f548-401d-b63b-caf0dc28df5f",img_uid:a},c,c)}}]),angular.module("ngSwApp").controller("FacesettingsCtrl",["$routeParams","betaface","toastr","$location","userFace",function(a,b,c,d,e){function f(a){return b.getInfo(a)}function g(a){if(0!==a.int_response)c.warning(a.string_response,"Photon pattern recognition failed"),j.uid="",j.ready=!0;else{if(!(a.faces.length>1)){var b={},e=a.faces[0],f=e.tags;console.log(e.tags);for(var g=0;g<f.length;g++){var h=i(f[g].name);b[h]=f[g].value}return console.log(b),b}c.error("Let's try again","Multiple organisms detected"),d.path("/")}}function h(a){return k>=10?(c.warning("Manual processing fallback engaged","Photon pattern recognition failed"),j.uid="",void(j.ready=!0)):void f(a).$promise.then(function(b){return 1===b.int_response?(k++,void setTimeout(function(){h(a)},2e3)):(e.setFaceData(g(b)),j.faceData=e.getFaceData(),void(j.ready=!0))},function(){c.warning("Manual processing fallback engaged","Photon pattern recognition failed"),j.uid="",j.ready=!0})}function i(a){return a.replace(/(?:^\w|[A-Z]|\b\w)/g,function(a,b){return 0===b?a.toLowerCase():a.toUpperCase()}).replace(/\s+/g,"")}var j=this;j.ready=!1,j.uid=a.uid||"",j.mode=j.uid?"recognize":"manual",j.faceData={age:"23"};var k=0;"manual"===j.mode?j.ready=!0:h(j.uid),j.updateAndContinue=function(){e.setFaceDataNormalized(j.faceData),d.path("/processing")}}]),angular.module("ngSwApp").directive("faceForm",[function(){return{template:'<form><div ng-repeat="(prop, val) in model" class="form-group"><label>{{prop}}</label><!-- text --><input type="text" class="form-control" ng-if="[\'gender\', \'side\'].indexOf(prop) === -1" ng-model="model[prop]"><input type="text" colorpicker="hex" ng-if="prop !== \'age\' && [\'gender\', \'side\'].indexOf(prop) === -1" ng-model="model[prop]" /><!-- <color-picker ng-if="prop !== \'age\' && [\'gender\', \'side\'].indexOf(prop) === -1" ng-model="model[prop]" color-picker-format="hex"></color-picker> --><!-- end text --><!-- dropdown --><select class="form-control" ng-if="[\'gender\', \'side\'].indexOf(prop) > -1" ng-model="model[prop]"><option ng-repeat="optionVal in availableOptions[prop]">{{optionVal}}</option></select><!-- end dropdown --></div></form>{{model}}',scope:{model:"="},restrict:"E",link:function(a,b,c){a.availableOptions=function(){return{gender:["female","male"],side:["dark","light"]}}()}}}]),angular.module("ngSwApp").service("guid",[function(){this.generate=function(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}}]),angular.module("ngSwApp").controller("SwapitestCtrl",["swapi",function(a){var b=this;b.ready=!1,a.people.all().then(function(a){b.people=a,b.ready=!0})}]),angular.module("ngSwApp").service("userFace",function(){var a={};this.setFaceData=function(b){a.age=b.age,a.gender=b.gender,a.side="yes"===b.smile?"light":"dark",a.eyeColour=b.colorEyes,a.skinColour=b.colorSkin,a.hairColour=b.colorHair,console.log("updated userFace",a)},this.setFaceDataNormalized=function(b){a=b},this.getFaceData=function(){return a}}),angular.module("ngSwApp").service("colourMapper",function(){var a={colors:[{name:"blue",hex:"0000FF"},{name:"yellow",hex:"FFFF00"},{name:"red",hex:"FF0000"},{name:"brown",hex:"6A3A0A"},{name:"blue-gray",hex:"8F8FFF"},{name:"black",hex:"000000"},{name:"orange",hex:"FFA500"},{name:"hazel",hex:"FFCA23"},{name:"pink",hex:"FFB2C2"},{name:"unknown",hex:"FFF3C0"},{name:"red, blue",hex:"FFB8C7"},{name:"gold",hex:"FFCA23"},{name:"green, yellow",hex:"E0D823"},{name:"white",hex:"CCCCCC"},{name:"dark",hex:"524729"}]},b={colors:[{name:"fair",hex:"FFE0BD"},{name:"gold",hex:"FFD700"},{name:"white, blue",hex:"C2BDFF"},{name:"white",hex:"FAFAFA"},{name:"light",hex:"FFEEDB"},{name:"white, red",hex:"FFBBBB"},{name:"unknown",hex:"666666"},{name:"green",hex:"77FF77"},{name:"green-tan, brown",hex:"CCF179"},{name:"pale",hex:"FFE8DE"},{name:"metal",hex:"E3CFC5"},{name:"dark",hex:"D7B998"},{name:"brown mottle",hex:"9C856A"},{name:"brown",hex:"B59369"},{name:"grey",hex:"AAAAAA"},{name:"mottled green",hex:"80A16A"},{name:"orange",hex:"D47B4A"},{name:"blue, grey",hex:"AFBEE4"},{name:"grey, red",hex:"F17D6F"},{name:"red",hex:"FF2222"},{name:"blue",hex:"2222FF"},{name:"grey, blue",hex:"A49CF1"},{name:"grey, green, yellow",hex:"FBE6A1"},{name:"yellow",hex:"FFF21F"},{name:"tan",hex:"BA581F"},{name:"fair, green, yellow",hex:"F3ED30"},{name:"silver, red",hex:"FF9276"},{name:"green, grey",hex:"91F2AC"},{name:"red, blue, white",hex:"F4AACC"},{name:"brown, white",hex:"B88975"},{name:"none",hex:"00000A"}]};this.compare=function(a,b){return a.distance<b.distance?-1:a.distance>b.distance?1:0},this.getClosestSkin=function(a){for(var c=[],d=0;d<b.colors.length;d++)c[d].name=b.colors[d].name,c[d].distance=this.getHexProximity(a,b.colors[d].hex);return c.sort(this.compare),c},this.getSkinHex=function(a){return"undefined"!=typeof b[a]?b[a]:!1},this.getEyeHex=function(b){return"undefined"!=typeof a[b]?a[b]:!1},this.getHexProximity=function(a,b){var c=this.splitHex(a),d=this.splitHex(b),e=[this.hexToInt(c[0]),this.hexToInt(c[1]),this.hexToInt(c[2])],f=[this.hexToInt(d[0]),this.hexToInt(d[1]),this.hexToInt(d[2])],g=this.rgbToXyz(e[0],e[1],e[2]),h=this.rgbToXyz(f[0],f[1],f[2]),i=this.xyzToLab(g[0],g[1],g[2]),j=this.xyzToLab(h[0],h[1],h[2]),k=this.cie1994(i,j,!1);return k},this.hexToInt=function(a){var b=a.toString(16);return parseInt(b,16)},this.splitHex=function(a){return[a.substr(0,2),a.substr(2,2),a.substr(4,2)]},this.rgbToXyz=function(a,b,c){var d=a/255,e=b/255,f=c/255;d>.04045?d=Math.pow((d+.055)/1.055,2.4):d/=12.92,e>.04045?e=Math.pow((e+.055)/1.055,2.4):e/=12.92,f>.04045?f=Math.pow((f+.055)/1.055,2.4):f/=12.92,d=100*d,e=100*e,f=100*f;var g=.4124*d+.3576*e+.1805*f,h=.2126*d+.7152*e+.0722*f,i=.0193*d+.1192*e+.9505*f;return[g,h,i]},this.xyzToLab=function(a,b,c){var d=95.047,e=100,f=108.883,g=a/d,h=b/e,i=c/f;g=g>.008856?Math.pow(g,1/3):7.787*g+16/116,h=h>.008856?Math.pow(h,1/3):7.787*h+16/116,i=i>.008856?Math.pow(i,1/3):7.787*i+16/116;var j=116*h-16,k=500*(g-h),l=200*(h-i);return[j,k,l]},this.cie1994=function(a,b,c){a={l:a[0],a:a[1],b:a[2]},b={l:b[0],a:b[1],b:b[2]};var d,e,f,g=1,h=1;c?(d=.014,e=.048,f=2):(d=.015,e=.045,f=1);var i=Math.sqrt(a.a*a.a+a.b*a.b),j=Math.sqrt(b.a*b.a+b.b*b.b),k=1+d*i,l=1+e*i,m=1,n=a.a-b.a,o=a.b-b.b,p=i-j,q=a.l-b.l,r=Math.sqrt(n*n+o*o-p*p);return Math.sqrt(Math.pow(q/(f*m),2)+Math.pow(p/(h*l),2)+Math.pow(r/(g*k),2))}}),angular.module("ngSwApp").controller("ProcessingCtrl",["$location","swapi","userFace",function(a,b,c){var d=this;d.userFace=c.getFaceData(),d.processing=!0,b.people.all().then(function(a){d.swapiData=a,console.log(a)})}]),angular.module("ngSwApp").run(["$templateCache",function(a){a.put("views/about.html","<p>This is the about view.</p>"),a.put("views/facesettings.html",'<p>This is the faceSettings view.</p> <p ng-show="faceSettings.uid.length">Using face ID {{faceSettings.uid}}</p> <p ng-show="!faceSettings.uid.length">Using manual entry</p> <div class="row"> <div class="col-sm-12"> <face-form ng-show="faceSettings.ready" model="faceSettings.faceData"></face-form> </div> </div> <div class="row"> <br> <div class="col-sm-12"> <a ng-show="faceSettings.ready" ng-click="faceSettings.updateAndContinue()" class="btn btn-block btn-success">Continue</a> </div> </div>'),a.put("views/main.html",'<div class="jumbotron"> <webcam></webcam> </div>'),a.put("views/processing.html",'<p>This is the processing view.</p> <h1 ng-show="processing.processing">Processing</h1> <h1 ng-show="!processing.processing">Ready</h1> {{processing.swapiData}} {{processing.userFace}}'),a.put("views/swapitest.html",'<div ng-show="swapitest.ready" ng-repeat="person in swapitest.people">{{person}}</div> <div ng-show="!swapitest.ready">Loading</div>')}]);