"use strict";angular.module("ngSwApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","toastr"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",controllerAs:"main"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl",controllerAs:"about"}).when("/faceSettings/:uid?",{templateUrl:"views/facesettings.html",controller:"FacesettingsCtrl",controllerAs:"faceSettings"}).otherwise({redirectTo:"/"})}]),angular.module("ngSwApp").controller("MainCtrl",function(){}),angular.module("ngSwApp").controller("AboutCtrl",function(){this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}),function(){navigator.getMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,window.hasUserMedia=function(){return navigator.getMedia?!0:!1}}(),angular.module("ngSwApp").directive("webcam",["toastr","betaface","$routeParams","$location",function(a,b,c,d){return{template:'<div class="webcam-container"><div class="row"><div class="col-lg-6 col-sm-12 text-center"><button class="btn btn-lg btn-default" ng-click="savePhoto()" ng-disabled="!photoReady">Take Photo</button></div><div class="col-lg-6 col-sm-12 text-center"><button class="btn btn-lg btn-default" ng-click="uploadPhoto()" ng-disabled="!uploadReady">Upload Photo</button></div></div><!-- webcam itself is inserted below --><div class="row"><div class="webcam-video col-lg-6 col-sm-12 text-center"></div><div class="webcam-photo col-lg-6 col-sm-12 text-center"></div></div></div>',restrict:"E",replace:!0,transclude:!0,scope:{onError:"&",onStream:"&",onStreaming:"&",placeholder:"=",config:"=channel"},link:function(c,e){var f=null,g=null,h=null;c.config=c.config||{},c.photoReady=!1,c.uploadReady=!1;var i=function(a){a&&angular.element(a).remove()},j=function(){g&&"function"==typeof g.stop&&g.stop(),f&&delete f.src},k=function(b){if(a.success("Photon receptor detected"),g=b,navigator.mozGetUserMedia)f.mozSrcObject=b;else{var d=window.URL||window.webkitURL;f.src=d.createObjectURL(b)}f.play(),c.config.video=f,c.onStream&&c.onStream({stream:b}),c.photoReady=!0},l=function(b){a.warning("Falling back to manual entry","Photon receptor failure"),i(h),console&&console.log&&console.log("Webcam initialization failed: ",b),c.onError&&c.onError({err:b}),d.path("/faceSettings")},m=(c.savePhoto=function(){if(!c.config.canvas){var a=document.createElement("canvas");a.setAttribute("width",f.videoWidth),a.setAttribute("height",f.videoHeight),e.find(".webcam-photo").append(a),c.config.canvas=a}var b=c.config.canvas,d=b.getContext("2d");d.drawImage(f,0,0,f.width,f.height);var g=b.toDataURL("image/png");b.setAttribute("src",g),c.uploadReady=!0},c.uploadPhoto=function(){var c=e.find(".webcam-photo canvas").attr("src");c=c.split(",")[1];var f=b.upload(c);f.then(function(a){d.path("/faceSettings/"+a.img_uid)},function(b){a.warning("Manual processing fallback engaged","Photon pattern recognition failed"),d.path("/faceSettings")})},function(){f=document.createElement("video"),f.setAttribute("class","webcam-live"),f.setAttribute("autoplay",""),e.find(".webcam-video").append(f),c.placeholder&&(h=document.createElement("img"),h.setAttribute("class","webcam-loader"),h.src=c.placeholder,e.find(".webcam-video").append(h));var a=!1,b=e.width=c.config.videoWidth||320,d=e.height=0;if(!window.hasUserMedia())return void l({code:-1,msg:"Browser does not support getUserMedia."});var g={video:!0,audio:!1};navigator.getMedia(g,k,l),f.addEventListener("canplay",function(){if(!a){var e=b/f.videoWidth;d=f.videoHeight*e||c.config.videoHeight,f.setAttribute("width",b),f.setAttribute("height",d),a=!0,c.config.video=f,i(h),c.onStreaming&&c.onStreaming()}},!1)}),n=function(){j(),f.remove()};c.$on("$destroy",j),c.$on("START_WEBCAM",m),c.$on("STOP_WEBCAM",n),m()}}}]),angular.module("ngSwApp").service("betaface",["$resource",function(a){function b(a){console.log(a)}function c(a){var b=[];return Array.prototype.forEach.call(a,function(a){b.push(a.charCodeAt())}),b}var d="d45fd466-51e2-4701-8da8-04351c872236",e="171e8465-f548-401d-b63b-caf0dc28df5f",f="http://www.betafaceapi.com/service_json.svc/",g={uploadImage:{method:"POST",params:{},url:f+"UploadNewImage_File"},getInfo:{method:"POST",params:{},url:f+"GetImageInfo"}},h=a(f,{},g);this.upload=function(a){var f=c(a);return h.uploadImage({},{api_key:d,api_secret:e,original_filename:"image.png",detection_flags:"classifiers",imagefile_data:f},b,b)},this.getInfo=function(a){return h.getInfo({},{api_key:"d45fd466-51e2-4701-8da8-04351c872236",api_secret:"171e8465-f548-401d-b63b-caf0dc28df5f",img_uid:a},b,b)}}]),angular.module("ngSwApp").controller("FacesettingsCtrl",["$routeParams","betaface","toastr","$location",function(a,b,c,d){function e(a){return b.getInfo(a)}function f(a){if(0!==a.int_response)c.error("Let's try again","No human organisms detected"),d.path("/");else{if(!(a.faces.length>1)){var b={},e=a.faces[0],f=e.tags;console.log(e.tags);for(var g=0;g<f.length;g++){var i=h(f[g].name);b[i]=f[g].value}return console.log(b),b}c.error("Let's try again","Multiple organisms detected"),d.path("/")}}function g(a){return j>=10?(c.warning("Manual processing fallback engaged","Photon pattern recognition failed"),i.uid="",void(i.ready=!0)):void e(a).$promise.then(function(b){1===b.int_response&&(j++,setTimeout(function(){g(a)},2e3)),i.faceData=f(b),i.ready=!0},function(){c.warning("Manual processing fallback engaged","Photon pattern recognition failed"),i.uid="",i.ready=!0})}function h(a){return a.replace(/(?:^\w|[A-Z]|\b\w)/g,function(a,b){return 0===b?a.toLowerCase():a.toUpperCase()}).replace(/\s+/g,"")}var i=this;i.ready=!1,i.uid=a.uid||"",i.uid="28d3ea52-1094-4739-b11a-38d767edcdff",i.mode=i.uid?"recognize":"manual",i.faceData={age:"23"};var j=0;"manual"===i.mode?i.ready=!0:g(i.uid)}]),angular.module("ngSwApp").directive("faceForm",function(){return{template:'<div ng-repeat="(prop, val) in model"><p>{{prop}}: {{val}}</p></div>',scope:{model:"="},restrict:"E",link:function(a,b,c){}}}),angular.module("ngSwApp").run(["$templateCache",function(a){a.put("views/about.html","<p>This is the about view.</p>"),a.put("views/facesettings.html",'<p>This is the faceSettings view.</p> <p ng-show="faceSettings.mode===\'recognize\'">The UID is {{faceSettings.uid}}</p> <face-form ng-show="faceSettings.ready" model="faceSettings.faceData"></face-form>'),a.put("views/main.html",'<div class="jumbotron"> <webcam></webcam> </div>')}]);